<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PrintMate Admin - Order Detail</title>
<link rel="stylesheet" href="../css/theme.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* Prevent vertical button stretching */
.action-stack .btn {
  width: 100%;
  padding: 12px 16px;
}

.action-row {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.action-row select {
  flex: 1;
  padding: 10px;
}
</style>
</head>

<body class="admin">

<div class="header">
  <div class="brand">PrintMate Admin</div>
  <div class="nav">
    <a href="index.html">Dashboard</a>
    <a href="orders.html">Orders</a>
  </div>
</div>

<div class="container">

<section class="page-header">
  <div>
    <div class="eyebrow">Order Detail</div>
    <div class="page-title" id="orderTitle">Order</div>
    <div class="subtitle" id="orderSubtitle">Loading order...</div>
  </div>
  <div class="actions">
    <button class="btn ghost" id="refreshBtn">Refresh</button>
    <a class="btn primary" href="orders.html">Back to Orders</a>
  </div>
</section>

<div id="state" class="state"></div>

<section class="grid-2">

<!-- LEFT PANEL -->
<div class="panel">
  <div>
    <div class="panel-title">Order Overview</div>
    <div class="panel-subtitle">Current status and job details</div>
  </div>
  <div class="info-grid" id="orderInfo"></div>
</div>

<!-- RIGHT PANEL -->
<div class="panel">
  <div>
    <div class="panel-title">Actions</div>
    <div class="panel-subtitle">Use only valid transitions</div>
  </div>

  <div class="action-stack">
    <button class="btn primary" id="startBtn">Start Printing</button>
    <button class="btn primary" id="completeBtn">Mark Completed</button>
    <button class="btn primary" id="deliverBtn">Mark Delivered</button>
    <button class="btn ghost" id="finalizeBtn">Finalize Cost</button>

    <div class="action-row">
      <select id="paymentMode">
        <option value="CASH">Cash</option>
        <option value="UPI">UPI</option>
      </select>
      <button class="btn ghost" id="payBtn">Mark Paid</button>
    </div>

    <div class="note" id="actionNote"></div>
  </div>
</div>

</section>

<section class="panel">
  <div>
    <div class="panel-title">Invoice</div>
    <div class="panel-subtitle">Generated after payment</div>
  </div>
  <div class="info-grid" id="invoiceInfo"></div>
</section>

</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="/frontend/ui/js/admin.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

const orderId = new URLSearchParams(window.location.search).get("id");

const orderTitle = document.getElementById("orderTitle");
const orderSubtitle = document.getElementById("orderSubtitle");
const orderInfo = document.getElementById("orderInfo");
const invoiceInfo = document.getElementById("invoiceInfo");
const stateDiv = document.getElementById("state");

const startBtn = document.getElementById("startBtn");
const completeBtn = document.getElementById("completeBtn");
const deliverBtn = document.getElementById("deliverBtn");
const finalizeBtn = document.getElementById("finalizeBtn");
const payBtn = document.getElementById("payBtn");
const paymentMode = document.getElementById("paymentMode");
const refreshBtn = document.getElementById("refreshBtn");
const actionNote = document.getElementById("actionNote");

let currentOrder = null;

/* Utilities */

function formatCurrency(value) {
  if (value == null) return "-";
  return new Intl.NumberFormat("en-IN", {
    style: "currency",
    currency: "INR",
    maximumFractionDigits: 0
  }).format(Number(value));
}

/* Render Order */

function renderOrder(order) {
  const status = order.status?.toUpperCase() || "UNKNOWN";
  const payment = order.payment_status?.toUpperCase() || "UNKNOWN";

  orderTitle.textContent = "Order #" + order.id;
  orderSubtitle.textContent = status + " | " + payment;

  orderInfo.innerHTML = `
    <div class="info-card"><div class="info-label">Student</div><div class="info-value">${order.student_name ?? "-"}</div></div>
    <div class="info-card"><div class="info-label">Roll No</div><div class="info-value">${order.student_roll_no ?? "-"}</div></div>
    <div class="info-card"><div class="info-label">Pages</div><div class="info-value">${order.total_pages ?? "-"}</div></div>
    <div class="info-card"><div class="info-label">Estimated Cost</div><div class="info-value">${formatCurrency(order.estimated_cost)}</div></div>
    <div class="info-card"><div class="info-label">Final Cost</div><div class="info-value">${formatCurrency(order.final_cost)}</div></div>
    <div class="info-card"><div class="info-label">Created</div><div class="info-value">${new Date(order.created_at).toLocaleString()}</div></div>
  `;

  /* PDF Preview */
  if (order.document_url) {
    orderInfo.innerHTML += `
      <div class="info-card" style="grid-column:1/-1">
        <div class="info-label">Document</div>
        <div class="info-value">
          <strong>${order.document_name}</strong>
          <div style="margin-top:12px">
            <iframe
              src="https://docs.google.com/gview?url=${encodeURIComponent(order.document_url)}&embedded=true"
              width="100%"
              height="600"
              style="border-radius:12px;border:1px solid #e0e0e0;">
            </iframe>
          </div>
          <div style="margin-top:12px">
            <a class="btn primary" href="${order.document_url}" target="_blank">
              Open / Print PDF
            </a>
          </div>
        </div>
      </div>
    `;
  }

  updateActions(order);
}

/* Action visibility */

function updateActions(order) {
  const status = order.status;
  const payment = order.payment_status;

  startBtn.style.display = status === "PENDING" ? "block" : "none";
  completeBtn.style.display = status === "IN_PROGRESS" ? "block" : "none";
  deliverBtn.style.display = status === "COMPLETED" && payment === "PAID" ? "block" : "none";
  finalizeBtn.style.display = status === "PENDING" && !order.final_cost ? "block" : "none";
  payBtn.style.display = payment !== "PAID" && order.final_cost ? "block" : "none";
}

/* Load Order */

function loadOrder() {
  if (!orderId) {
    stateDiv.textContent = "Missing order id.";
    return;
  }

  stateDiv.textContent = "Loading order...";

  adminApi.get(`/admin/orders/${orderId}`)
    .then(res => {
      currentOrder = res.data;
      stateDiv.textContent = "";
      renderOrder(currentOrder);
      loadInvoice();
    })
    .catch(err => {
      console.error(err);
      stateDiv.textContent = "Failed to load order.";
    });
}

/* Invoice */

function loadInvoice() {
  adminApi.get(`/orders/${orderId}/invoice`)
    .then(res => {
      invoiceInfo.innerHTML = `
        <div class="info-card"><div class="info-label">Invoice</div><div class="info-value">${res.data.invoice_number}</div></div>
        <div class="info-card"><div class="info-label">Total</div><div class="info-value">${formatCurrency(res.data.total)}</div></div>
      `;
    })
    .catch(() => {
      invoiceInfo.innerHTML = "<div class='panel-subtitle'>No invoice generated.</div>";
    });
}

/* Action Handlers */

function updateStatus(status) {
  adminApi.patch(`/orders/${orderId}/status`, { status })
    .then(loadOrder)
    .catch(() => actionNote.textContent = "Failed to update status.");
}

function finalizeCost() {
  adminApi.post(`/orders/${orderId}/finalize-cost`)
    .then(loadOrder)
    .catch(() => actionNote.textContent = "Failed to finalize cost.");
}

function markPaid() {
  adminApi.patch(`/orders/${orderId}/pay`, { payment_mode: paymentMode.value })
    .then(loadOrder)
    .catch(() => actionNote.textContent = "Payment failed.");
}

startBtn.onclick = () => updateStatus("IN_PROGRESS");
completeBtn.onclick = () => updateStatus("COMPLETED");
deliverBtn.onclick = () => updateStatus("DELIVERED");
finalizeBtn.onclick = finalizeCost;
payBtn.onclick = markPaid;
refreshBtn.onclick = loadOrder;

loadOrder();

});
</script>

</body>
</html>
