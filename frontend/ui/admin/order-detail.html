<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PrintMate Admin - Order Detail</title>

<link rel="stylesheet" href="../css/theme.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
.action-stack .btn {
  width: 100%;
  padding: 12px 16px;
}

.action-row {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.action-row select {
  flex: 1;
  padding: 10px;
}

#pdfViewer canvas {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
}
</style>
</head>

<body class="admin">

<div class="header">
  <div class="brand">PrintMate Admin</div>
  <div class="nav">
    <a href="index.html">Dashboard</a>
    <a href="orders.html">Orders</a>
  </div>
</div>

<div class="container">

<section class="page-header">
  <div>
    <div class="eyebrow">Order Detail</div>
    <div class="page-title" id="orderTitle">Order</div>
    <div class="subtitle" id="orderSubtitle">Loading order...</div>
  </div>
  <div class="actions">
    <button class="btn ghost" id="refreshBtn">Refresh</button>
    <a class="btn primary" href="orders.html">Back to Orders</a>
  </div>
</section>

<div id="state" class="state"></div>

<section class="grid-2">

<div class="panel">
  <div>
    <div class="panel-title">Order Overview</div>
    <div class="panel-subtitle">Current status and job details</div>
  </div>
  <div class="info-grid" id="orderInfo"></div>
</div>

<div class="panel">
  <div>
    <div class="panel-title">Actions</div>
    <div class="panel-subtitle">Use only valid transitions</div>
  </div>

  <div class="action-stack">
    <button class="btn primary" id="startBtn">Start Printing</button>
    <button class="btn primary" id="completeBtn">Mark Completed</button>
    <button class="btn primary" id="deliverBtn">Mark Delivered</button>
    <button class="btn ghost" id="finalizeBtn">Finalize Cost</button>
    <div class="action-row">
      <select id="paymentMode">
        <option value="CASH">Cash</option>
        <option value="UPI">UPI</option>
      </select>
      <button class="btn primary" id="payBtn">Mark Paid</button>
    </div>
    <div class="note" id="actionNote"></div>
  </div>
</div>

</section>

<section class="panel">
  <div>
    <div class="panel-title">Invoice</div>
    <div class="panel-subtitle">Generated after payment</div>
  </div>
  <div class="info-grid" id="invoiceInfo"></div>
</section>

</div>


<!-- Use local vendor scripts to avoid CDN/Tracking Prevention issues -->

<!-- Axios FIRST -->
<script src="../vendor/axios.min.js"></script>

<!-- PDF.js -->
<script src="../vendor/pdfjs/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "../vendor/pdfjs/pdf.worker.min.js";
</script>

<!-- API -->
<script src="../js/api.js"></script>

<!-- Admin Header Setup (VERY IMPORTANT) -->
<script src="../js/admin.js"></script>

<!-- Order Logic -->
<script src="../js/order.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

const orderId = new URLSearchParams(window.location.search).get("id");

const orderTitle = document.getElementById("orderTitle");
const orderSubtitle = document.getElementById("orderSubtitle");
const orderInfo = document.getElementById("orderInfo");
const invoiceInfo = document.getElementById("invoiceInfo");
const stateDiv = document.getElementById("state");


const startBtn = document.getElementById("startBtn");
const completeBtn = document.getElementById("completeBtn");
const deliverBtn = document.getElementById("deliverBtn");
const finalizeBtn = document.getElementById("finalizeBtn");
const payBtn = document.getElementById("payBtn");
const paymentMode = document.getElementById("paymentMode");
const refreshBtn = document.getElementById("refreshBtn");
const actionNote = document.getElementById("actionNote");

let currentOrder = null;

/* ---------------- Utilities ---------------- */

function formatCurrency(value) {
  if (value == null) return "-";
  return new Intl.NumberFormat("en-IN", {
    style: "currency",
    currency: "INR",
    maximumFractionDigits: 0
  }).format(Number(value));
}

function loadPDF(url) {
  const container = document.getElementById("pdfViewer");
  if (!container) return;

  container.innerHTML = "";

  pdfjsLib.getDocument(url).promise.then(pdf => {
    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
      pdf.getPage(pageNum).then(page => {

        const viewport = page.getViewport({ scale: 1.2 });
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");

        canvas.height = viewport.height;
        canvas.width = viewport.width;
        canvas.style.width = "100%";
        canvas.style.marginBottom = "16px";

        container.appendChild(canvas);

        page.render({
          canvasContext: context,
          viewport: viewport
        });
      });
    }
  });
}

/* ---------------- Render Order ---------------- */

function renderOrder(order) {

  currentOrder = order;

  orderTitle.textContent = "Order #" + order.id;
  orderSubtitle.textContent =
    order.status + " | " + order.payment_status;

  orderInfo.innerHTML = `
    <div class="info-card"><div class="info-label">Student</div><div class="info-value">${order.student_name ?? "-"}</div></div>
    <div class="info-card"><div class="info-label">Roll No</div><div class="info-value">${order.student_roll_no ?? "-"}</div></div>
    <div class="info-card"><div class="info-label">Pages</div><div class="info-value">${order.total_pages ?? "-"}</div></div>
    <div class="info-card"><div class="info-label">Estimated Cost</div><div class="info-value">${formatCurrency(order.estimated_cost)}</div></div>
    <div class="info-card"><div class="info-label">Final Cost</div><div class="info-value">${formatCurrency(order.final_cost)}</div></div>
    <div class="info-card"><div class="info-label">Payment Method</div><div class="info-value">${order.payment_method ?? "-"}</div></div>
    <div class="info-card"><div class="info-label">Verification</div><div class="info-value">${order.payment_verification_status ?? "-"}</div></div>
  `;
  // Auto-detect payment mode for Mark Paid
  if (order.payment_method && ["CASH", "UPI"].includes(order.payment_method.toUpperCase())) {
    paymentMode.value = order.payment_method.toUpperCase();
  } else {
    paymentMode.value = "CASH";
  }

  /* -------- Document -------- */
  if (order.document_url) {
    orderInfo.innerHTML += `
      <div class="info-card" style="grid-column:1/-1">
        <div class="info-label">Document</div>
        <div class="info-value">
          <strong>${order.document_name}</strong>
          <div id="pdfViewer" style="margin-top:12px"></div>
          <div style="margin-top:12px">
            <a class="btn primary" href="${order.document_url}" target="_blank">
              Open / Print PDF
            </a>
          </div>
        </div>
      </div>
    `;
    loadPDF(order.document_url);
  }

  /* -------- UPI Screenshot -------- */
  if (order.payment_screenshot) {
    orderInfo.innerHTML += `
      <div class="info-card" style="grid-column:1/-1">
        <div class="info-label">UPI Screenshot</div>
        <div class="info-value">
          <img src="${order.payment_screenshot}"
               style="max-width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:12px"/>
          <div style="display:flex;gap:10px">
            <button class="btn primary" id="approveBtn">Approve</button>
            <button class="btn ghost" id="rejectBtn">Reject</button>
          </div>
        </div>
      </div>
    `;
  }

  bindVerificationButtons();
  updateActions(order);
}

/* ---------------- Approve / Reject ---------------- */

function bindVerificationButtons() {

  const approveBtn = document.getElementById("approveBtn");
  const rejectBtn = document.getElementById("rejectBtn");

  if (approveBtn) {
    approveBtn.onclick = () => {
      api.patch(`/orders/${orderId}/verify-upi`, {
        decision: "APPROVE"
      }).then(loadOrder)
        .catch(() => alert("Approval failed"));
    };
  }

  if (rejectBtn) {
    rejectBtn.onclick = () => {
      api.patch(`/orders/${orderId}/verify-upi`, {
        decision: "REJECT"
      }).then(loadOrder)
        .catch(() => alert("Rejection failed"));
    };
  }
}

/* ---------------- Actions Visibility ---------------- */

function updateActions(order) {

  startBtn.style.display =
    order.status === "PENDING" ? "block" : "none";

  completeBtn.style.display =
    order.status === "IN_PROGRESS" ? "block" : "none";

  deliverBtn.style.display =
    order.status === "COMPLETED" &&
    order.payment_status === "PAID" ? "block" : "none";

  finalizeBtn.style.display =
    order.status === "PENDING" && !order.final_cost ? "block" : "none";

  payBtn.style.display =
    order.payment_status !== "PAID" && order.final_cost ? "block" : "none";
  // Hide paymentMode select, show only Mark Paid button with method label
  if (order.payment_method) {
    paymentMode.style.display = "none";
    payBtn.textContent = `Mark Paid (${order.payment_method})`;
  } else {
    paymentMode.style.display = "none";
    payBtn.textContent = "Mark Paid";
  }
}

/* ---------------- Load Order ---------------- */

function loadOrder() {

  if (!orderId) {
    stateDiv.textContent = "Missing order id.";
    return;
  }

  stateDiv.textContent = "Loading order...";

  api.get(`/orders/detail/${orderId}`)
    .then(res => {
      stateDiv.textContent = "";
      renderOrder(res.data);
      loadInvoice();
    })
    .catch(() => {
      stateDiv.textContent = "Failed to load order.";
    });
}

/* ---------------- Invoice ---------------- */

function loadInvoice() {
  api.get(`/orders/${orderId}/invoice`)
    .then(res => {
      invoiceInfo.innerHTML = `
        <div class="info-card">
          <div class="info-label">Invoice</div>
          <div class="info-value">${res.data.invoice_number}</div>
        </div>
        <div class="info-card">
          <div class="info-label">Total</div>
          <div class="info-value">${formatCurrency(res.data.total)}</div>
        </div>
      `;
    })
    .catch(() => {
      invoiceInfo.innerHTML =
        "<div class='panel-subtitle'>No invoice generated.</div>";
    });
}

/* ---------------- Status Actions ---------------- */

function updateStatus(status) {
  api.patch(`/orders/${orderId}/status`, { status })
    .then(loadOrder)
    .catch(() => actionNote.textContent = "Status update failed.");
}

function finalizeCost() {
  api.post(`/orders/${orderId}/finalize-cost`)
    .then(loadOrder)
    .catch(() => actionNote.textContent = "Finalize failed.");
}

function markPaid() {
  // Use the payment_method from the order, not from select
  const method = currentOrder && currentOrder.payment_method ? currentOrder.payment_method : "CASH";
  api.patch(`/orders/${orderId}/pay`, {
    payment_mode: method
  }).then(loadOrder)
    .catch(() => actionNote.textContent = "Payment failed.");
}

/* ---------------- Bindings ---------------- */


if (startBtn) startBtn.onclick = () => updateStatus("IN_PROGRESS");
if (completeBtn) completeBtn.onclick = () => updateStatus("COMPLETED");
if (deliverBtn) deliverBtn.onclick = () => updateStatus("DELIVERED");
if (finalizeBtn) finalizeBtn.onclick = finalizeCost;
if (payBtn) payBtn.onclick = markPaid;
if (refreshBtn) refreshBtn.onclick = loadOrder;

loadOrder();

});
</script>

</body>
</html>
