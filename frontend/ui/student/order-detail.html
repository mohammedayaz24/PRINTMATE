<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PrintMate - Order Detail</title>
  <link rel="stylesheet" href="../css/theme.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="student">

<div class="header">
  <div class="brand">PrintMate</div>
  <div class="nav">
    <a href="shops.html">Shops</a>
    <a href="order.html">Order</a>
    <a href="index.html">Dashboard</a>
    <a href="orders.html">Orders</a>
    <a href="completed.html">History</a>
    <a href="profile.html">Profile</a>
  </div>
</div>

<div class="container">
  <section class="page-header">
    <div>
      <div class="eyebrow">Order Detail</div>
      <div class="page-title" id="orderTitle">Order</div>
      <div class="subtitle" id="orderSubtitle">Loading order data...</div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="refreshBtn">Refresh</button>
      <a class="btn primary" href="orders.html">Back to Orders</a>
    </div>
  </section>

  <div id="state" class="state"></div>

  <section class="grid-2">
    <div class="panel">
      <div>
        <div class="panel-title">Order Overview</div>
        <div class="panel-subtitle">Status, payment, and cost details</div>
      </div>
      <div class="info-grid" id="orderInfo"></div>
      <button class="btn ghost" id="cancelBtn">Cancel Order</button>
    </div>

    <div class="panel">
      <div>
        <div class="panel-title">Print Options</div>
        <div class="panel-subtitle" id="optionsSubtitle">Editable while the order is pending</div>
      </div>
      <form id="optionsForm">
        <div>
          <label for="pageRanges">Page ranges</label>
          <input id="pageRanges" type="text" placeholder="1-10, 15, 18-20" />
        </div>
        <div class="inline">
          <div>
            <label for="colorMode">Color mode</label>
            <select id="colorMode">
              <option value="BW">Black and white</option>
              <option value="COLOR">Color</option>
            </select>
          </div>
          <div>
            <label for="sideMode">Side mode</label>
            <select id="sideMode">
              <option value="SINGLE">Single</option>
              <option value="DOUBLE">Double</option>
            </select>
          </div>
        </div>
        <div class="inline">
          <div>
            <label for="orientation">Orientation</label>
            <select id="orientation">
              <option value="PORTRAIT">Portrait</option>
              <option value="LANDSCAPE">Landscape</option>
            </select>
          </div>
          <div>
            <label for="binding">Binding</label>
            <select id="binding">
              <option value="NONE">None</option>
              <option value="SPIRAL">Spiral</option>
            </select>
          </div>
          <div>
            <label for="copies">Copies</label>
            <input id="copies" type="number" min="1" max="10" value="1" />
          </div>
        </div>
        <button class="btn primary" type="submit">Save Print Options</button>
        <div class="panel-subtitle" id="optionsState"></div>
      </form>
    </div>
  </section>

  <section class="grid-2">
    <div class="panel">
      <div>
        <div class="panel-title">Documents</div>
        <div class="panel-subtitle">Uploads are stored locally on the server.</div>
      </div>
      <form id="uploadForm">
        <input id="uploadFile" type="file" accept="application/pdf,image/png,image/jpeg" />
        <button class="btn primary" type="submit">Upload Document</button>
        <div class="panel-subtitle" id="uploadState"></div>
      </form>
      <div class="list" id="documentsList"></div>
    </div>

    <div class="panel">
      <div>
        <div class="panel-title">Invoice</div>
        <div class="panel-subtitle">Available after payment</div>
      </div>
      <div class="info-grid" id="invoiceInfo"></div>
      <button class="btn ghost" id="invoiceBtn">Load Invoice</button>
      <div class="panel-subtitle" id="invoiceState"></div>
    </div>
  </section>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="../js/api.js"></script>

<script>
const params = new URLSearchParams(window.location.search);
const orderId = params.get("id");

const orderTitle = document.getElementById("orderTitle");
const orderSubtitle = document.getElementById("orderSubtitle");
const orderInfo = document.getElementById("orderInfo");
const invoiceInfo = document.getElementById("invoiceInfo");
const invoiceState = document.getElementById("invoiceState");
const stateDiv = document.getElementById("state");

const cancelBtn = document.getElementById("cancelBtn");
const refreshBtn = document.getElementById("refreshBtn");
const invoiceBtn = document.getElementById("invoiceBtn");

let currentOrder = null;

function formatDate(value) {
  if (!value) return "-";
  return new Date(value).toLocaleString();
}

function formatCurrency(value) {
  if (value === null || value === undefined) return "-";
  return "â‚¹" + value;
}

function renderOrder(order) {
  const status = order.status?.toUpperCase() || "UNKNOWN";
  const payment = order.payment_status?.toUpperCase() || "UNKNOWN";

  orderTitle.textContent = "Order #" + order.id;
  orderSubtitle.textContent =
    status.replace(/_/g, " ") + " | " + payment;

  orderInfo.innerHTML = `
    <div class="info-card">
      <div class="info-label">Student</div>
      <div class="info-value">${order.full_name ?? "-"}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Roll No</div>
      <div class="info-value">${order.roll_no ?? "-"}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Pages</div>
      <div class="info-value">${order.total_pages ?? "-"}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Estimated Cost</div>
      <div class="info-value">â‚¹${order.estimated_cost ?? "-"}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Final Cost</div>
      <div class="info-value">â‚¹${order.final_cost ?? "-"}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Created</div>
      <div class="info-value">${new Date(order.created_at).toLocaleString()}</div>
    </div>

    ${
      order.document_url
        ? `
        <div class="info-card" style="grid-column:1/-1">
          <div class="info-label">Document</div>
          <div class="info-value">
            <strong>${order.document_name}</strong>
            <div style="margin-top:12px">
              <iframe 
                src="${order.document_url}"
                width="100%"
                height="500"
                style="border-radius:12px;border:1px solid #e0e0e0;">
              </iframe>
            </div>
            <div style="margin-top:12px">
              <a class="btn primary"
                 href="${order.document_url}"
                 target="_blank">
                 Open / Print PDF
              </a>
            </div>
          </div>
        </div>
        `
        : ""
    }
  `;
}


function renderInvoice(invoice) {
  if (!invoice) {
    invoiceInfo.innerHTML = "<div>No invoice generated yet.</div>";
    return;
  }

  invoiceInfo.innerHTML = `
    <div class="info-card">
      <div class="info-label">Invoice Number</div>
      <div class="info-value">${invoice.invoice_number}</div>
    </div>
    <div class="info-card">
      <div class="info-label">Total</div>
      <div class="info-value">${formatCurrency(invoice.total)}</div>
    </div>
    <div class="info-card">
      <div class="info-label">Paid At</div>
      <div class="info-value">${formatDate(invoice.paid_at)}</div>
    </div>
  `;
}

function loadOrder() {
  if (!orderId) {
    stateDiv.textContent = "Missing order id.";
    return;
  }

  stateDiv.textContent = "Loading order...";

  api.get(`/student/orders/${orderId}`)
    .then(res => {
      currentOrder = res.data;
      stateDiv.textContent = "";
      renderOrder(currentOrder);
    })
    .catch(err => {
      console.error(err);
      stateDiv.textContent = "Failed to load order.";
    });
}

function loadInvoice() {
  invoiceState.textContent = "Loading invoice...";

  // ðŸ”¥ FIXED ROUTE
  api.get(`/student/orders/${orderId}/invoice`)
    .then(res => {
      invoiceState.textContent = "";
      renderInvoice(res.data);
    })
    .catch(() => {
      invoiceState.textContent = "No invoice available.";
      renderInvoice(null);
    });
}

cancelBtn.addEventListener("click", () => {
  api.patch(`/student/orders/${orderId}/cancel`)
    .then(() => loadOrder())
    .catch(() => {
      stateDiv.textContent = "Unable to cancel order.";
    });
});

refreshBtn.addEventListener("click", loadOrder);
invoiceBtn.addEventListener("click", loadInvoice);

loadOrder();
</script>
</body>
</html>