<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PrintMate - Order Detail</title>
  <link rel="stylesheet" href="../css/theme.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="student">

<div class="header">
  <div class="brand">PrintMate</div>
  <div class="nav">
    <a href="shops.html">Shops</a>
    <a href="order.html">Order</a>
    <a href="index.html">Dashboard</a>
    <a href="orders.html">Orders</a>
    <a href="completed.html">History</a>
    <a href="profile.html">Profile</a>
  </div>
</div>

<div class="container">
  <section class="page-header">
    <div>
      <div class="eyebrow">Order Detail</div>
      <div class="page-title" id="orderTitle">Order</div>
      <div class="subtitle" id="orderSubtitle">Loading order data...</div>
    </div>
    <div class="actions">
      <button class="btn ghost" id="refreshBtn">Refresh</button>
      <a class="btn primary" href="orders.html">Back to Orders</a>
    </div>
  </section>

  <div id="state" class="state"></div>

  <section class="grid-2">
    <div class="panel">
      <div>
        <div class="panel-title">Order Overview</div>
        <div class="panel-subtitle">Status, payment, and cost details</div>
      </div>
      <div class="info-grid" id="orderInfo"></div>
      <button class="btn ghost" id="cancelBtn">Cancel Order</button>
    </div>

    <div class="panel">
      <div>
        <div class="panel-title">Print Options</div>
        <div class="panel-subtitle" id="optionsSubtitle">Editable while the order is pending</div>
      </div>
      <form id="optionsForm">
        <div>
          <label for="pageRanges">Page ranges</label>
          <input id="pageRanges" type="text" placeholder="1-10, 15, 18-20" />
        </div>
        <div class="inline">
          <div>
            <label for="colorMode">Color mode</label>
            <select id="colorMode">
              <option value="BW">Black and white</option>
              <option value="COLOR">Color</option>
            </select>
          </div>
          <div>
            <label for="sideMode">Side mode</label>
            <select id="sideMode">
              <option value="SINGLE">Single</option>
              <option value="DOUBLE">Double</option>
            </select>
          </div>
        </div>
        <div class="inline">
          <div>
            <label for="orientation">Orientation</label>
            <select id="orientation">
              <option value="PORTRAIT">Portrait</option>
              <option value="LANDSCAPE">Landscape</option>
            </select>
          </div>
          <div>
            <label for="binding">Binding</label>
            <select id="binding">
              <option value="NONE">None</option>
              <option value="SPIRAL">Spiral</option>
            </select>
          </div>
          <div>
            <label for="copies">Copies</label>
            <input id="copies" type="number" min="1" max="10" value="1" />
          </div>
        </div>
        <button class="btn primary" type="submit">Save Print Options</button>
        <div class="panel-subtitle" id="optionsState"></div>
      </form>
    </div>
  </section>

  <section class="grid-2">
    <div class="panel">
      <div>
        <div class="panel-title">Documents</div>
        <div class="panel-subtitle">Uploads are stored locally on the server.</div>
      </div>
      <form id="uploadForm">
        <input id="uploadFile" type="file" accept="application/pdf,image/png,image/jpeg" />
        <button class="btn primary" type="submit">Upload Document</button>
        <div class="panel-subtitle" id="uploadState"></div>
      </form>
      <div class="list" id="documentsList"></div>
    </div>
    <div id="upiSection" style="display:none">
    <h3>Scan to Pay</h3>
    <canvas id="upiQR"></canvas>

    <div style="margin-top:15px">
      <input type="file" id="paymentScreenshot" accept="image/*">
      <button class="btn primary" id="uploadScreenshotBtn">
        Upload Payment Screenshot
      </button>
    </div>
  </div>


    <div class="panel">
      <div>
        <div class="panel-title">Invoice</div>
        <div class="panel-subtitle">Available after payment</div>
      </div>
      <div class="info-grid" id="invoiceInfo"></div>
      <button class="btn ghost" id="invoiceBtn">Load Invoice</button>
      <div class="panel-subtitle" id="invoiceState"></div>
    </div>
  </section>
</div>
<script src="../vendor/axios.min.js"></script>
<script src="../vendor/pdfjs/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc = "../vendor/pdfjs/pdf.worker.min.js";
</script>
<script src="../js/api.js"></script>
<script src="../js/order.js"></script>

<script>
const params = new URLSearchParams(window.location.search);
const orderId = params.get("id");

const orderTitle = document.getElementById("orderTitle");
const orderSubtitle = document.getElementById("orderSubtitle");
const orderInfo = document.getElementById("orderInfo");
const invoiceInfo = document.getElementById("invoiceInfo");
const invoiceState = document.getElementById("invoiceState");
const stateDiv = document.getElementById("state");

const cancelBtn = document.getElementById("cancelBtn");
const refreshBtn = document.getElementById("refreshBtn");
const invoiceBtn = document.getElementById("invoiceBtn");

const upiSection = document.getElementById("upiSection");
const qrCanvas = document.getElementById("upiQR");
const uploadScreenshotBtn = document.getElementById("uploadScreenshotBtn");
const paymentScreenshotInput = document.getElementById("paymentScreenshot");

let currentOrder = null;

/* -------------------- Helpers -------------------- */

function formatDate(value) {
  if (!value) return "-";
  return new Date(value).toLocaleString();
}

function formatCurrency(value) {
  if (value === null || value === undefined) return "-";
  return "â‚¹" + value;
}

/* -------------------- QR Generator -------------------- */

function generateQR(upiLink) {
  qrCanvas.innerHTML = "";
  QRCode.toCanvas(qrCanvas, upiLink, {
    width: 220
  });
}

/* -------------------- Render Order -------------------- */

function renderOrder(response) {

  const order = response.order;
  const documents = response.documents;

  currentOrder = order;

  const status = order.status?.toUpperCase() || "UNKNOWN";
  const payment = order.payment_status?.toUpperCase() || "UNKNOWN";

  orderTitle.textContent = "Order #" + order.id;
  orderSubtitle.textContent =
    status.replace(/_/g, " ") + " | " + payment;

  orderInfo.innerHTML = `
    <div class="info-card">
      <div class="info-label">Student</div>
      <div class="info-value">${order.full_name ?? "-"}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Roll No</div>
      <div class="info-value">${order.roll_no ?? "-"}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Pages</div>
      <div class="info-value">${order.total_pages ?? "-"}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Estimated Cost</div>
      <div class="info-value">${formatCurrency(order.estimated_cost)}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Final Cost</div>
      <div class="info-value">${formatCurrency(order.final_cost)}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Payment Mode</div>
      <div class="info-value">${order.payment_mode ?? "-"}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Payment Status</div>
      <div class="info-value">${order.payment_status}</div>
    </div>

    <div class="info-card">
      <div class="info-label">Verification</div>
      <div class="info-value">${order.payment_verification_status ?? "-"}</div>
    </div>
  `;

  /* -------------------- Documents -------------------- */

  const docList = document.getElementById("documentsList");
  docList.innerHTML = "";

  documents.forEach(doc => {
    docList.innerHTML += `
      <div class="list-item">
        <a href="${doc.file_url}" target="_blank">${doc.original_filename}</a>
      </div>
    `;
  });

  /* -------------------- UPI SECTION -------------------- */

  if (
    order.payment_mode === "UPI" &&
    order.final_cost &&
    order.payment_status !== "PAID"
  ) {

    upiSection.style.display = "block";

    api.get(`/orders/${order.id}/upi-link`)
      .then(res => {
        generateQR(res.data.upi_link);
      });

  } else {
    upiSection.style.display = "none";
  }

  /* Lock cancel if not pending */
  cancelBtn.style.display =
    order.status === "PENDING" ? "inline-flex" : "none";
}

/* -------------------- Upload Screenshot -------------------- */

uploadScreenshotBtn.addEventListener("click", () => {

  const file = paymentScreenshotInput.files[0];

  if (!file) {
    alert("Please select screenshot");
    return;
  }

  const formData = new FormData();
  formData.append("file", file);

  api.post(`/student/orders/${orderId}/upload-payment-proof`, formData, {
    headers: { "Content-Type": "multipart/form-data" }
  })
    .then(() => {
      alert("Screenshot uploaded. Waiting for admin verification.");
      loadOrder();
    })
    .catch(() => {
      alert("Upload failed.");
    });
});

/* -------------------- Load Order -------------------- */

function loadOrder() {
  if (!orderId) {
    stateDiv.textContent = "Missing order id.";
    return;
  }
  stateDiv.textContent = "Loading order...";
  api.get(`/student/orders/${orderId}`)
    .then(res => {
      stateDiv.textContent = "";
      renderOrder(res.data);
    })
    .catch(err => {
      console.error(err);
      stateDiv.textContent = "Failed to load order.";
    });
}

/* -------------------- Invoice -------------------- */

function loadInvoice() {
  invoiceState.textContent = "Loading invoice...";

  api.get(`/student/orders/${orderId}/invoice`)
    .then(res => {
      invoiceState.textContent = "";
      invoiceInfo.innerHTML = `
        <div class="info-card">
          <div class="info-label">Invoice Number</div>
          <div class="info-value">${res.data.invoice_number}</div>
        </div>
        <div class="info-card">
          <div class="info-label">Total</div>
          <div class="info-value">${formatCurrency(res.data.total)}</div>
        </div>
        <div class="info-card">
          <div class="info-label">Paid At</div>
          <div class="info-value">${formatDate(res.data.paid_at)}</div>
        </div>
      `;
    })
    .catch(() => {
      invoiceState.textContent = "No invoice available.";
      invoiceInfo.innerHTML = "";
    });
}

/* -------------------- Cancel -------------------- */

cancelBtn.addEventListener("click", () => {
  api.patch(`/student/orders/${orderId}/cancel`)
    .then(() => loadOrder())
    .catch(() => {
      stateDiv.textContent = "Unable to cancel order.";
    });
});

refreshBtn.addEventListener("click", loadOrder);
invoiceBtn.addEventListener("click", loadInvoice);

loadOrder();
</script>

</body>
</html>